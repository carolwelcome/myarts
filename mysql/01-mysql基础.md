---
title: 01.MySQL基础架构
date: 2019-05-29 10:36:22
categories:  #分类
    - attendance
tags:   #标签
    - MySQL
    - 架构 
description: 
    MySQL基础知识学习
---

###开篇
MySQL用了好多年了，但是用到就是那些个简单的功能，比如查询、创建、更新、删除简单的功能，再复杂一点就是触发器、视图、授权等功能。这些对于MySQL来说简直就是九牛一毛，太小儿科了，我要成为一个深度的学习者这些对于我来说是远远不够的，不在乎别人的眼光，我只是在自己的道路上慢慢成长。无独有偶，刚刚在上周六(5月25日)参加的系统分析师考试，竟然遇到了MySQL主从复制的问题，但这么简单的问题而我却没有回答的很好（原题：MySQL主从数据同步复制的三种类型是什么？）这无疑对我产生了很大的影响。于此同时，我知道现在是有必要把MySQL的知识重头再学习一遍了，我也知道在学习的过程中肯定会遇到很多问题，使我坚持不下去。但是我还是想试试。

### 说明
本次MySQL的学习理论基础以极客时间的MySQL实战45讲为基础，如果想看原汁原味的课程希望大家去购买。`对于知识的付费多少钱都是值得的`。当然对学习结果的要求，我还是希望能够有更多自己的思考以及实践。我不怕别人说我，这么大岁数了竟然还看着人家的课程去学习之类的话，因为我只是在用自己的思路在构建属于我的知识体系。


### MySQL基础架构图

![MySQL基础架构图](img/basicarch.png)

MySQL可以分为Server层和存储引擎层：

Server层：连接器、查询缓存、分析器、优化器、执行器等，大多数的核心服务功能以及所有的内置函数，所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、p视图等。

存储引擎层：负责数据的存储和提取，是插件式的架构。支持InnoDB、MyISAM、Memeory（内存引擎）等，最常用的是InnoDB，是MySQL5.5.5版本开始成为默认存储引擎。可以在创建表的时候指定引擎，如
```SQL
	create table xxx() engine=memory
```
当然不同的存储引擎的表数据存取方式也是不一样的，支持的功能也不同。


#### Server层

##### 连接器
负责跟客户端建立连接、获取权限、维持和管理连接。需要注意的是一个用户连接建立以后，即使用管理员账号，对这个用户权限做了修改，也不会影响已经存在的连接权限，只有新建的连接才会使用新的权限设置。
```SQL
mysql -h$ip -P$port -u$user -p

```
连接完成后，可以使用show processlist命令中看到它，如果是处于空闲状态，command列显示为sleep，默认连接时间是8个小时可以用wait_timeout参数控制。建议减少建立连接的动作，尽量使用长连接，因为建立连接也是很消耗资源的。但是使用长连接也是有OOM的风险的，可以使用1、定期断开长连接，再重连的方式；2、在每次执行完一个比较大的操作后，通过mysql_reset_connection来重新初始化连接资源的方式来解决。
##### 查询缓存
MySQL拿到一个查询请求后，会先到查询缓存查看之间是否执行过这条语句，之前执行过的语句及其结果可能会以key-value对的形式，被直接缓存在内存中，key是查询语句，value是查询结果。如果能够在缓存中找到key,那么value值会被直接返回给客户端。如果语句不在缓存中，就会继续后面的执行阶段，执行完成后，执行结果会被存入查询缓存中。这个效率还是挺高的，但是大多数情况下不建议使用查询缓存，因为查询缓存往往弊大于利。（查询缓存非常容易失效，只要对表一更新，这个表上的所有缓存都被清空，因此，缓存的结果可能还没用就被清空了，反而对数据库的更新增加了负担）对于一些不经常改变的静态表，可以使用查询缓存，MySQL提供这种按需使用的方式，可以将query_cache_type设置在DEMAND,这样对于默认的语句都不使用缓存，对于确定使用查询缓存的语句，可以使用SQL_CACHE显式指定。
```SQL
mysql> select SQL_CACHE * from T where ID=10；

```
需要注意的是：MySQL8.0版本直接将查询缓存的整块功能都删除了，对不起，在下不彻底没有这块功能了。
##### 分析器
接上查询缓存没有命中的情况，开始真正执行语句。MySQL需要知道你要做什么，因些需要对SQL语句做解析。先做词法分析，说白了就是输入的一串字符+空格组成的SQL语句，需要被MySQL识别出来字符串是什么，代表什么。做完这些识别之后就要做语法分析，根据词法分析的结果，语法分析器会根据语法规则，判断你输入的SQL语句是否满足Mysql的语法。

##### 优化器
经过分析器之后，MySQL知道你要做什么了，但是在执行之前还需要先经过优化器的处理。优化器是在表里面有多个索引的时候，决定使用哪个索引，或者在一个语句关联的时候决定各个表的连接顺序。

##### 执行器
MySQL通过分析器知道了你要做什么，通过优化器之后知道了该怎么做，于是就到真正的执行阶段。顺序：先判断你对这个表有没有操作的权限 ，如果没有就返回错误，如果有就打开表继续执行。打开表的时候执行器会根据表的引擎定义，去使用这个引擎提供的接口。
（调用引擎接口，读取表的第一行，判断条件是否满足， 不满足就跳过，满足了就把结果存到结果集中。然后再调用下一行，重复相同的判断逻辑，直到取到这个表的最后一行。最终 将结果集返回给客户端）


可以自行以下面这条语句为基础，在脑子里面模拟一下这个SQL执行的过程。会有不一样的收获哦
```SQL

mysql> select * from T where ID=10；

```